<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArtSea - My Profile</title>
    <!-- Link to external CSS file -->
    <link rel="stylesheet" th:href="@{/styles.css}">
</head>
<body>
    <!--Navbar-->
    <div th:replace="header :: header"></div>



    <!-- Profile Content -->
    <div class="profile-container">
        <!-- Profile Header -->
        <div class="profile-header">
            <img src="/woman.jpg" alt="Profile Avatar" class="profile-avatar">

            <div class="profile-info">
                <h1 th:text="${user.username}"></h1>
                <p th:text="'Member since ' + ${#temporals.format(user.created_at, 'MMMM yyyy')}"></p>
                <div class="profile-stats">
                    <div class="stat-item">
                        <div class="stat-value" th:text="${totalBids}"></div>
                        <div class="stat-label">Bids</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" th:text="${totalWon}"></div>
                        <div class="stat-label">Won</div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Profile Tabs -->
        <div class="profile-tabs">
            <button class="tab-button active" data-tab="bids">Live Auction Bids</button>
            <button class="tab-button" data-tab="all-bids">All Bids</button>
            <button class="tab-button" data-tab="won-artwork">Won Artwork</button>
            <button class="tab-button" data-tab="pending-payment">Pending Payment</button>
            <button class="tab-button" data-tab="settings">Account Settings</button>
        </div>

        <!-- Bids Tab -->
        <div class="tab-content active" id="bids">
            <h2 class="section-title">Live Auction Bids</h2>
            <div class="bids-grid">
                <div class="bid-card" th:each="bidData : ${bidsData}">
                    <img th:src="@{${bidData.artwork.imageUrl}}" th:alt="${bidData.artwork.title}" class="bid-image">

                    <div class="bid-details">
                        <h3 class="bid-title" th:text="${bidData.artwork.title}"></h3>
                        <div class="bid-info">
                            <span class="bid-amount"
                                th:text="'â‚¹' + ${#numbers.formatDecimal(bidData.userBid, 0, 'COMMA', 2, 'POINT')}"></span>
                            <span class="bid-status" th:text="${bidData.status}"
                                th:classappend="${bidData.status == 'Winning'} ? ' status-winning' : ' status-outbid'"></span>
                        </div>
                        <div class="bid-auction-name" th:text="'Auction: ' + ${bidData.auction.auctionName}"></div>
                    </div>
                </div>
            </div>
        </div>
        <!-- All Bids Tab -->
        <div class="tab-content" id="all-bids">
            <h2 class="section-title">Bids History</h2>
            <div class="bids-grid">
                <div class="bid-card" th:each="bidData : ${allBids}">
                    <img th:src="@{${bidData.artwork.imageUrl}}"
                         th:alt="${bidData.artwork.title}"
                         class="bid-image">

                    <div class="bid-details">
                        <h3 class="bid-title" th:text="${bidData.artwork.title}"></h3>
                        <div class="bid-info">
                    <span class="bid-amount"
                          th:text="'â‚¹' + ${#numbers.formatDecimal(bidData.userBid, 0, 'COMMA', 2, 'POINT')}"></span>
                            <span class="bid-status" th:text="${bidData.status}"
                                  th:classappend="${bidData.status == 'Winning'} ? ' status-winning' : ' status-outbid'"></span>
                        </div>
                        <div class="bid-auction-name"
                             th:text="'Auction: ' + ${bidData.auction.auctionName}"></div>
                        <div class="bid-time"
                             th:text="'Placed on: ' + ${#temporals.format(bidData.bidTime, 'dd MMM yyyy HH:mm')}"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div class="tab-content" id="settings">
            <h2 class="section-title">Account Settings</h2>
            <form class="settings-form" th:action="@{/my-profile/save}" th:object="${user}" method="post">
                <div class="form-group">
                    <label for="name">Full Name</label>
                    <input type="text" id="name" th:field="*{username}" required>
                </div>
                <div class="form-group">
                    <label for="email">Email Address</label>
                    <input type="email" id="email" th:field="*{email}" disabled>
                    <input type="hidden" th:field="*{email}">
                </div>
                <div class="form-group">
                    <label for="phone">Phone Number</label>
                    <input type="tel" id="phone" th:field="*{phone}" required>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-cancel">Cancel</button>
                    <button type="submit" class="btn-save">Save Changes</button>
                </div>
            </form>
        </div>

        <!-- Pending Payment Tab -->
        <!-- Pending Payment Tab (move this inside .profile-container) -->
        <div class="tab-content" id="pending-payment">
            <h2 class="section-title">Pending Payments</h2>

            <div class="pending-grid">
                <div class="pending-card" th:each="payment : ${pendingPayments}">
                    <img th:src="@{${payment.artwork.imageUrl}}"
                         th:alt="${payment.artwork.title}"
                         class="pending-image"/>

                    <div class="pending-details">
                        <h3 th:text="${payment.artwork.title}"></h3>
                        <p th:text="'Auction: ' + ${payment.auction.auctionName}"></p>
                        <p th:text="'Winning Bid: â‚¹' + ${payment.finalBid}"></p>
                        <p th:text="'Status: ' + ${payment.paymentStatus}"></p>

                        <div class="pending-actions">
                            <button type="button" class="btn-next" onclick="showAddressForm(this)">Next</button>
                        </div>

                        <form class="address-form" onsubmit="startPayment(event)">
                            <input type="hidden" name="bidId" th:value="${payment.bidId}"/>
                            <label th:for="${'address-' + payment.bidId}">Delivery Address:</label>
                            <textarea th:id="${'address-' + payment.bidId}" name="address" required></textarea>
                            <div style="display:flex; gap:8px; margin-top:8px;">
                                <button type="submit" class="btn-pay">Pay Now</button>
                                <button type="button" class="btn-cancel" onclick="hideAddressForm(this)">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-content" id="won-artwork">
            <h2 class="section-title">Won Artworks</h2>

            <div class="pending-grid">
                <div class="pending-card" th:each="order : ${wonOrders}">
                    <img th:src="@{${order.artwork.imageUrl}}"
                         th:alt="${order.artwork.title}"
                         class="pending-image"/>

                    <div class="pending-details">
                        <h3 th:text="${order.artwork.title}"></h3>
                        <p th:text="'Auction: ' + ${order.auction.auctionName}"></p>
                        <p th:text="'Final Bid: â‚¹' + ${order.finalBid}"></p>

                        <p th:if="${order.status == 'SUCCESS'}" style="color: green; font-weight: bold;">
                            âœ… Payment Successful
                        </p>
                        <p th:if="${order.status == 'SUCCESS'}">
                            Seller will process within 1 week
                        </p>

                        <p th:if="${order.status == 'PROCESSED'}" style="color: blue; font-weight: bold;">
                            ðŸ“¦ Seller Processed Order
                        </p>
                        <p th:if="${order.status == 'PROCESSED'}"
                           th:text="'Tracking Id: ' + ${order.trackingId}"></p>
                    </div>
                </div>
            </div>
        </div>
        <!-- All Bids Tab -->
        <div class="tab-content" id="all-bids">
            <h2 class="section-title">Bids History</h2>
            <div class="bids-grid">
                <div class="bid-card" th:each="bidData : ${allBids}">
                    <img th:src="@{${bidData.artwork.imageUrl}}"
                         th:alt="${bidData.artwork.title}"
                         class="bid-image">




        <!-- Footer -->
    <div th:replace="footer :: footer"></div>

    <script src="/home.js"></script>
    <!-- Small JS to toggle address form -->
    <script>
        // Better selector: finds .address-form within the same .pending-card
        function showAddressForm(btn) {
            const card = btn.closest('.pending-card');
            if (!card) return;
            const form = card.querySelector('.address-form');
            if (!form) return;
            form.style.display = 'block';
            btn.style.display = 'none';
        }
    </script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script>
        async function startPayment(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);

            // Call backend to save address + create Razorpay order
            const res = await fetch('/payment/address', { method: 'POST', body: formData });
            const data = await res.json();

            const options = {
                "key": data.key,
                "amount": data.amount,
                "currency": data.currency,
                "name": "ArtSea Auctions",
                "description": "Payment for Artwork",
                "order_id": data.razorpayOrderId,
                "handler": function (response){
                    // send success to backend
                    fetch('/payment/success', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            razorpay_payment_id: response.razorpay_payment_id,
                            razorpay_order_id: response.razorpay_order_id,
                            razorpay_signature: response.razorpay_signature,
                            bidId: data.bidId
                        })
                    }).then(() => window.location.reload());
                }
            };
            new Razorpay(options).open();
        }
    </script>

    <script>
        // Improved tab scrolling behavior
        document.addEventListener('DOMContentLoaded', function() {
            const tabsContainer = document.querySelector('.profile-tabs');
            const activeTab = document.querySelector('.tab-button.active');

            if (tabsContainer && activeTab) {
                // Scroll active tab into view on mobile
                if (window.innerWidth < 768) {
                    setTimeout(() => {
                        activeTab.scrollIntoView({
                            behavior: 'smooth',
                            block: 'nearest',
                            inline: 'center'
                        });
                    }, 100);
                }
            }
        });
        // Robust tab toggling: matches data-tab to element id exactly
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                // remove active from all
                document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                button.classList.add('active');
                const tabId = button.getAttribute('data-tab'); // e.g. "pending-payment"
                const content = document.getElementById(tabId);
                if (content) content.classList.add('active');
            });
        });

        // Show address form inside the same pending-card
        function showAddressForm(btn) {
            const card = btn.closest('.pending-card');
            if (!card) return;
            const form = card.querySelector('.address-form');
            if (!form) return;
            form.classList.add('show');
            // hide next button (but don't remove layout)
            btn.style.display = 'none';
        }

        function hideAddressForm(btn) {
            // btn is inside the form (Cancel). Find the card and revert.
            const form = btn.closest('.address-form');
            if (!form) return;
            form.classList.remove('show');
            const card = btn.closest('.pending-card');
            if (!card) return;
            const nextBtn = card.querySelector('.btn-next');
            if (nextBtn) nextBtn.style.display = '';
        }
    </script>

</body>
</html>