<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" th:href="@{/styles.css}">
    <title>ArtSea - Live Artwork Lots</title>
    <style>
        /* Base Styles from home.html */

        /* Auction Results Section Styles */
        .auction-results-container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 0 20px;
        }

        .auction-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 30px;
        }

        @media (min-width: 768px) {
            .auction-header {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }

        .auction-title {
            font-size: 28px;
            font-weight: bold;
            text-transform: uppercase;
            text-align: center;
            margin-bottom: 20px;
        }

        @media (min-width: 768px) {
            .auction-title {
                margin-bottom: 0;
                text-align: left;
            }
        }

        .auction-tabs {
            display: flex;
            height: 50px;
            border: 1px solid #c0c0c0;
            border-radius: 6px;
            overflow: hidden;
        }

        .auction-tab {
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: 500;
            background: white;
            color: #333;
            text-decoration: none;
        }

        .auction-tab.active {
            background: #003366;
            color: white;
        }

        .auction-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 22px;
            padding: 0 20px;
        }

        @media (min-width: 640px) {
            .auction-grid {
                grid-template-columns: repeat(3, 1fr);
                padding: 0;
            }
        }

        .auction-card {
            max-width: 410px;
            display: flex;
            flex-direction: column;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            border: 1px solid #eee;
            position: relative;
            transition: transform 0.2s;
        }

        .auction-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }

        .live-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #e53e3e;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .auction-image-container {
            position: relative;
            width: 100%;
            height: 248px;
            margin-bottom: 20px;
        }

        .auction-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
            cursor: pointer;
            border-radius: 4px;
        }

        .auction-name {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #222;
        }

        .auction-date {
            font-size: 14px;
            font-weight: 300;
            margin-bottom: 8px;
            color: #666;
        }

        .auction-time-left {
            color: #e53e3e;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .current-bid {
            font-size: 14px;
            margin-bottom: 8px;
        }

        .bid-amount {
            font-weight: 600;
            color: #003366;
            font-size: 16px;
        }

        .next-bid {
            font-size: 13px;
            color: #666;
            margin-bottom: 12px;
        }

        .auction-divider {
            border: none;
            border-top: 1px solid #e2e8f0;
            margin: 12px 0;
        }

        .bid-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 12px;
        }

        .bid-btn {
            background: #003366;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .bid-btn:hover {
            background: #002244;
        }

        .bid-status {
            font-size: 13px;
            margin-top: 8px;
            min-height: 18px;
            text-align: center;
        }

        .bid-success {
            color: #38a169;
        }

        .bid-error {
            color: #e53e3e;
        }

        .bidders-count {
            font-size: 13px;
            color: #666;
            margin-top: 8px;
            text-align: center;
        }

        /* Bid history panel */
        .bid-history {
            margin-top: 15px;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 6px;
            max-height: 120px;
            overflow-y: auto;
        }

        .bid-history-title {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #444;
        }

        .bid-item {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            padding: 4px 0;
            border-bottom: 1px solid #eee;
        }

        .bidder-name {
            color: #666;
        }

        .bid-value {
            font-weight: 500;
            color: #003366;
        }

        /* Responsive styles */
        @media (max-width: 768px) {
            .auction-title {
                font-size: 24px;
            }

            .auction-tabs {
                width: 100%;
            }
        }

        @media (max-width: 640px) {
            .auction-grid {
                grid-template-columns: 1fr;
            }

            .auction-card {
                max-width: 100%;
            }
        }


        .toast {
            min-width: 250px;
            margin-bottom: 10px;
            padding: 14px 24px;
            background-color: #38a169; /* green for success */
            color: white;
            border-radius: 10px;
            box-shadow: 0 6px 12px rgba(0,0,0,0.25);
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.4s ease, transform 0.4s ease;
            font-weight: 500;
            text-align: center;
            font-size: 16px;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .toast.error {
            background-color: #e53e3e; /* red for errors */
        }

    </style>
</head>
<body>
<!--Navbar    -->
<div th:replace="header :: header"></div>
<!-- Auction Results Content -->
<!-- Keep your existing Thymeleaf rendering -->
<div class="auction-grid">
    <div class="auction-card"
         th:each="artworkData : ${artworks}"
         th:attr="data-artwork-id=${artworkData.artwork.artworkId}">

        <div class="auction-image-container">
            <img th:src="@{${artworkData.artwork.imageUrl}}"
                 th:alt="${artworkData.artwork.title}"
                 class="auction-image">
        </div>

        <h4 class="auction-name" th:text="${artworkData.artwork.title}"></h4>

        <!-- Current Bid -->
        <p class="current-bid">
            Current Bid: <span class="bid-amount"
                               th:text="'₹' + ${#numbers.formatDecimal(artworkData.currentBid, 0, 'COMMA', 2, 'POINT')}"></span>
        </p>
        <p class="next-bid">
            Highest Bidder: <span class="highest-bidder-name" th:text="${artworkData.highestBidderName}">No bids yet</span>
        </p>


        <div class="bid-form">
            <!-- Store current bid as data attribute for JS to calculate next bid -->
            <button class="bid-btn"
                    th:attr="data-current-bid=${artworkData.currentBid}"
                    th:attrappend="data-starting-price=${artworkData.artwork.startingPrice}"
                    onclick="placeBid(this)">
                Bid ₹<span th:text="${#numbers.formatDecimal(artworkData.currentBid, 0, 'COMMA', 2, 'POINT')}"></span>
            </button>


        </div>

    </div>
</div>
<div th:replace="footer :: footer"></div>
<script src="/home.js"></script>

<div id="notification-container" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000;"></div>




<!-- SockJS -->
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<!-- StompJS (browser global UMD build) -->
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>


<script>
    function showToast(message, type = 'success') {
        const container = document.getElementById('notification-container');
        const toast = document.createElement('div');
        toast.classList.add('toast');

        if(type === 'error') {
            toast.style.backgroundColor = '#e53e3e';
        }

        toast.textContent = message;
        container.appendChild(toast);

        // Trigger animation
        setTimeout(() => toast.classList.add('show'), 10);

        // Remove after 3 seconds
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => container.removeChild(toast), 400);
        }, 3000);
    }

    // Tab switching (optional)
    const tabs = document.querySelectorAll('.auction-tab');
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            tabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
        });
    });

    let stompClient = null;

    // Helper: update button to 10% higher than current bid
    function updateNextBidButton(card, currentBid, startingPrice, hasBids = false) {
        const btn = card.querySelector(".bid-btn");

        let nextBid;
        if (!hasBids && currentBid === startingPrice) {
            // First bid: allow same as starting price
            nextBid = startingPrice;
        } else {
            // Subsequent bids: 10% increment
            nextBid = currentBid * 1.1;
        }

        btn.textContent = "Bid ₹" + nextBid.toFixed(2);
        btn.setAttribute("data-next-bid", nextBid.toFixed(2));
        btn.setAttribute("data-current-bid", currentBid.toFixed(2));
    }


    // Initialize all buttons on page load
    // Initialize all buttons on page load with starting price consideration
    document.querySelectorAll(".auction-card").forEach(card => {
        const currentBid = parseFloat(card.querySelector(".bid-btn").getAttribute("data-current-bid"));
        const startingPrice = parseFloat(card.querySelector(".bid-btn").getAttribute("data-starting-price"));
        const highestBidder = card.querySelector(".highest-bidder-name").textContent.trim();

        const hasBids = highestBidder && highestBidder !== "No bids yet";
        updateNextBidButton(card, currentBid, startingPrice, hasBids);
    });



    // Connect WebSocket
    function connect() {
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket); // Works now

        stompClient.connect({}, function () {
            document.querySelectorAll(".auction-card").forEach(card => {
                const artworkId = card.getAttribute("data-artwork-id");

                stompClient.subscribe(`/topic/auction/${artworkId}`, function (message) {
                    const bid = JSON.parse(message.body);
                    const currentBid = parseFloat(bid.bidAmount.toString().replace(/[^\d.]/g, ''));
                    const startingPrice = parseFloat(card.querySelector(".bid-btn").getAttribute("data-starting-price"));

                    // Update UI
                    card.querySelector(".bid-amount").textContent = "₹" + currentBid.toFixed(2);

                    // Now always true because we know at least one bid exists
                    updateNextBidButton(card, currentBid, startingPrice, true);

                    // Update highest bidder name
                    const highestBidderElem = card.querySelector(".highest-bidder-name");
                    if (highestBidderElem) {
                        highestBidderElem.textContent = bid.bidderName || 'No bids yet';
                    }
                });
            });
        });
    }



    // Called when user clicks "Bid"
    function placeBid(button) {
        const card = button.closest(".auction-card");
        const artworkId = card.getAttribute("data-artwork-id");
        const bidAmount = button.getAttribute("data-next-bid");

        fetch(`/bid/${artworkId}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ amount: bidAmount })
        })
            .then(res => res.json())
            .then(data => {
                if (!data.success) {
                    showToast('Failed: ' + data.message, 'error');
                } else {
                    showToast('Bid Placed Successfully!');
                }
            })
            .catch(err => showToast('Error placing bid.', 'error'));
    }


    window.addEventListener('load', connect);
</script>


</body>
</html>